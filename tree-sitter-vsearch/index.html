<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8">
  <title>Tree Sitter Document Search</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 20px;
      background-color: #f5f5f5;
    }

    .Search {
      margin-bottom: 20px;
    }

    .Search input {
      width: 300px;
      padding: 8px;
      font-size: 16px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    .Search button {
      padding: 8px 16px;
      font-size: 16px;
      cursor: pointer;
      background-color: #0066cc;
      color: #fff;
      border: none;
      border-radius: 4px;
      margin-left: 8px;
    }

    .results {
      background: #fff;
      padding: 15px;
      border-radius: 4px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .result-item {
      border-bottom: 1px solid #ddd;
      padding: 15px 0;
    }

    .result-item:last-child {
      border-bottom: none;
    }

    .result-header {
      margin-bottom: 8px;
    }

    .result-title {
      display: flex;
      align-items: baseline;
      margin: 0;
    }

    .result-title .title-link {
      font-size: 20px;
      color: #222;
      text-decoration: none;
      font-weight: 600;
    }

    .result-title .title-link:hover {
      text-decoration: underline;
    }

    .result-title .result-path {
      font-size: 14px;
      color: #666;
      margin-left: 8px;
      font-style: italic;
    }

    .result-link {
      margin-left: auto;
      font-size: 14px;
      color: #0066cc;
      text-decoration: none;
      font-weight: 500;
    }

    .result-link:hover {
      text-decoration: underline;
    }

    .result-snippet p {
      margin: 8px 0;
      font-size: 16px;
      line-height: 1.4;
    }

    .result-code h4 {
      margin: 10px 0 5px;
      font-size: 16px;
    }

    .code-lines {
      list-style: none;
      padding-left: 0;
      background: #f0f0f0;
      border-radius: 3px;
      overflow-x: auto;
    }

    .code-lines li {
      font-family: monospace;
      padding: 4px 8px;
      border-bottom: 1px solid #e0e0e0;
    }

    .code-lines li:last-child {
      border-bottom: none;
    }

    .no-results {
      text-align: center;
      color: #555;
      font-style: italic;
      padding: 20px 0;
    }
  </style>

</head>

<body>

  <div class="Search">
    <input type="search" placeholder="Type your search..." />
    <button id="searchBtn" type="button">Search</button>
  </div>

  <div class="results">
    <ul id="resultsList"></ul>
  </div>


  <script type="module">
    import { pipeline } from 'https://cdn.jsdelivr.net/npm/@huggingface/transformers@3.5.1';
    import { VectorSearch } from '../vector_search.js'


    // —————————————————————————————————————————————
    //  In-browser embedder with promise-based caching
    let _embedderPromise = null;
    function getEmbedder(model = "Xenova/all-MiniLM-L6-v2") {
      if (!_embedderPromise) {
        // pipeline() returns a Promise immediately, so we cache it right away
        _embedderPromise = pipeline("feature-extraction", model /*, { device: "webgpu" } */);
      }
      return _embedderPromise;
    }

    /**
     * Embed a single string into a fixed-size, normalized Float32Array.
     *
     * @param {string} text
     * @param {string} [model]
     * @returns {Promise<Float32Array>}
     */
    export async function embedText(text, model) {
      if (typeof text !== "string" || text.length === 0) {
        throw new TypeError("embedText: text must be a nonempty string");
      }
      const extractor = await getEmbedder(model);
      const tensor = await extractor(text, { pooling: "mean", normalize: true });
      return tensor.data;
    }


    const index = new VectorSearch();

    // —————————————————————————————————————————————
    //  App entry point
    (async () => {
      try {

        // Load precomputed vectors
        const resp = await fetch("./vectorized-tree-sitter.json");
        if (!resp.ok) {
          throw new Error(`Failed to fetch vectors: ${resp.status} ${resp.statusText}`);
        }
        const docs = await resp.json();
        index.loadDocs(docs);
        // Now that docs are ready, enable the UI
        $searchInput.disabled = false;
        $searchButton.disabled = false;
        $searchButton.textContent = 'Search';

      } catch (err) {
        console.error("Error initializing vector search app:", err);
      }
    })();

    // Grab references to the input, button, and results container
    const $searchInput = document.querySelector('.Search input');
    const $searchButton = document.getElementById('searchBtn');
    const $resultsList = document.getElementById('resultsList');

    const FLD_HEADER = 'header';
    const FLD_TEXT_BLOCKS = 'text_blocks';
    const FLD_CODE_BLOCKS = 'code_blocks';
    const FLD_FILE_PATH = "file_path";

    const NEW_LINE_SIGN = 'NEWLINE'

    // Function to perform the search and display results
    async function performSearch() {
      const query = $searchInput.value.trim();

      // If input is empty, clear the results
      if (!query) {
        $resultsList.innerHTML = '';
        return;
      }

      // Get search results
      // const results = miniSearch.search(query);
      const queryVector = await embedText(query);
      results = index.search(queryVector, 100);

      // Build HTML to display results
      if (results.length) {
        $resultsList.innerHTML = results.map(result => {
          const headerText = result[FLD_HEADER];
          const headerLink = result[FLD_FILE_PATH]
            .replace('tree-sitter/docs/src/', 'https://github.com/tree-sitter/tree-sitter/tree/master/docs/src/')
            + `#${headerText.toLowerCase().replace(/\s+/g, '-')}`;

          // Shorten file path for context
          const shortPath = result[FLD_FILE_PATH]
            .replace('tree-sitter/docs/src/', '')
            .replace(/\.md$/, '');

          const snippet = result[FLD_TEXT_BLOCKS]
            .replace(/NEWPARAGRAPH/g, '<br />')
            .replace(/NEWLINE/g, '<br />')
            .substring(0, 256) + '...';

          const codeLines = result[FLD_CODE_BLOCKS]
            .split(NEW_LINE_SIGN)
            .filter(line => line.length > 32)
            .map(line => `<li class="code-line">${line}</li>`)
            .join('');

          return `
        <li class="result-item">
          <header class="result-header">
            <h3 class="result-title">
              <a href="${headerLink}" class="title-link" target="_blank" rel="noopener noreferrer">${headerText}</a>
              <span class="result-path">${shortPath}</span>
              <a href="${headerLink}" class="result-link" target="_blank" rel="noopener noreferrer">View on GitHub</a>
            </h3>
          </header>
          <section class="result-snippet"><p>${snippet}</p></section>
          ${codeLines ? `<section class="result-code">
            <h4>Code Snippets:</h4>
            <ul class="code-lines">${codeLines}</ul>
          </section>` : ''}
        </li>
      `;
        }).join('');
      } else {
        $resultsList.innerHTML = '<li class="no-results">No results found. Try a different query.</li>';
      }

    }

    // Search on button click
    $searchButton.addEventListener('click', performSearch);
    $searchInput.addEventListener('keydown', function (event) {
      if (event.key === 'Enter') {
        performSearch();
      }
    });
  </script>

  <footer style="margin-top: 40px; text-align: center; font-size: 14px; color: #777;">
    <p>
      This search tool uses data from
      <a href="https://github.com/tree-sitter/tree-sitter" target="_blank" rel="noopener noreferrer">
        tree-sitter on GitHub
      </a>.
    </p>
  </footer>

</body>

</html>